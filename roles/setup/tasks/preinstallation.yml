---
- name: Remove swapfile from /etc/fstab
  mount:
    name: "{{ item }}"
    fstype: swap
    state: absent
  with_items:
    - swap
    - none

- name: Disable swap
  command: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Disable the ufw firewall 
  service:
    name: ufw
    state: stopped
    enabled: false

- name: Set ip_forward
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: yes
    reload: yes

# - name: Create containerd config file
#   file:
#     path: "/etc/modules-load.d/containerd.conf"
#     state: "touch"

# - name: Add conf for containerd
#   blockinfile:
#     path: "/etc/modules-load.d/containerd.conf"
#     block: |
#             overlay
#             br_netfilter

# - name: modprobe
#   become: yes
#   shell: |
#           modprobe overlay
#           modprobe br_netfilter

- name: Set system configurations for Kubernetes networking
  file:
    path: "/etc/sysctl.d/kubernetes.conf"
    state: "touch"

- name: Add conf for containerd
  blockinfile:
    path: "/etc/sysctl.d/kubernetes.conf"
    block: |
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            net.ipv4.ip_forward = 1

- name: Apply new settings
  become: yes
  command: sysctl --system

# - name: Install containerd
#   apt:
#     name: 
#       - containerd
#     state: present

# - name: Create containerd config directory
#   file: 
#     path=/etc/containerd 
#     state=directory

# - name: Install containerd
#   become: yes
#   shell: |
#           containerd config default | sudo tee /etc/containerd/config.toml
#           systemctl restart containerd